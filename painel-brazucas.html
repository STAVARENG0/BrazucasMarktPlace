<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Painel Brazucas</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
    :root {
  --cream:#f3eadf;
  --pill-1:#f6c34a;
  --pill-2:#f29278;
  --shadow: rgba(0,0,0,.14);
  --card:#1a1a1a;
  --muted:#6b635a;
  --white:#ffffff;
  --ink:#2b2b2b;
  --green:#28a745;
}
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
    body { background: var(--cream); color: var(--ink); padding: 20px; }
    h1 { text-align: center; margin-bottom: 20px; color: var(--ink); }
    .container { display: flex; gap: 20px; max-width: 1200px; margin: 0 auto; }
    .form-section, .list-section {
      flex: 1; background: var(--white); padding: 20px; border-radius: 12px; border:1px solid #e5dfd7;
      box-shadow: 0 10px 20px var(--shadow);
    }
    .form { display: flex; flex-direction: column; gap: 12px; }
    input, textarea, select { padding: 12px; border-radius: 10px; border: 1px solid #e5dfd7; font-size: 14px; background:#fff; }
    textarea { min-height: 80px; resize: vertical; }
    .upload-btn { display: inline-block; padding: 12px; border-radius: 9999px; background: linear-gradient(135deg,var(--pill-1),var(--pill-2)); color: #3a2a21; text-align: center; font-weight: 800; cursor: pointer; transition: 0.2s; box-shadow:0 6px 14px var(--shadow), inset 0 -2px 0 rgba(0,0,0,.12);}
    .upload-btn:hover { filter: brightness(1.08); }
    #fotos { display: none; }
    button { background: linear-gradient(135deg,var(--pill-1),var(--pill-2)); border: none; padding: 12px 16px; border-radius: 9999px; cursor: pointer; color:#3a2a21; font-weight: 800; transition: 0.2s; font-size: 15px; box-shadow:0 6px 14px var(--shadow), inset 0 -2px 0 rgba(0,0,0,.15);}
    button:hover { filter: brightness(1.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    table th, table td { border: 1px solid #e5dfd7; padding: 10px; text-align: left; }
    table th { background: #f9f4ed; }
    .preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .preview { position: relative; }
    .preview img { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 2px solid transparent; }
    .preview input[type="radio"] { position: absolute; top: 4px; left: 4px; transform: scale(1.2); }
    .alert { margin-top: 10px; padding: 10px; border-radius: 6px; text-align: center; display: none; }
    .alert.success { background: var(--green); color: white; }
    .config-btn { display:block; margin:0 auto 20px; background: linear-gradient(135deg,var(--pill-1),var(--pill-2)); border:none; color:#3a2a1f; padding:10px 16px; border-radius:9999px; font-size:14px; font-weight:900; cursor:pointer; box-shadow:0 6px 14px var(--shadow);}
    .modal{display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index:3000;}
    .modal.show{display:flex !important;}
    .modal-content{background:#fff; padding:20px; border-radius:12px; max-width:460px; width:92%; color:#2b2b2b; position:relative; border:1px solid #e5dfd7;}
    .action-buttons { display:flex; gap:6px; }
    .action-buttons button { flex:1; }

    .logo-small{width:64px;height:auto;display:block;margin:0 auto 20px; border-radius:8px;}
</style>
</head>
<body>
<h1 style="line-height:0;"><img src="logo.png" alt="Brazucas" class="logo-small"></h1>

<button class="config-btn" id="openGithubModal" type="button">Configura√ß√µes</button>
<div class="container">
  <div class="form-section">
    <form class="form" id="formProduto">
      <input id="titulo" placeholder="T√≠tulo do produto" required type="text"/>
      <input id="valor" placeholder="Valor (‚Ç¨)" required step="0.01" type="number"/>
      <textarea id="descricao" placeholder="Descri√ß√£o do produto"></textarea>
      <label>Departamento</label>
      <select id="departamento" required>
        <option value="">Selecione...</option>
        <option value="marketplace">Marketplace</option>
        <option value="servicos">Servi√ßos e Com√©rcios</option>
        <option value="eventos">Eventos</option>
      </select>
      <label>Estoque</label>
      <input id="estoque" min="0" placeholder="Quantidade em estoque" type="number" value="0"/>
      <label>WhatsApp do dono (somente n√∫meros, com DDI)</label>
      <input id="whatsapp" placeholder="Ex: 353899999999" type="tel" inputmode="numeric" pattern="\d*"/>
      <small style="color:var(--muted);margin-top:-6px;">Ser√° usado no bot√£o do produto para abrir conversa no WhatsApp.</small>
      <label class="upload-btn" for="fotos">üì∑ Adicionar Imagens</label>
      <input accept="image/*" id="fotos" multiple type="file"/>
      <div class="preview-container" id="preview"></div>
      <button type="submit">Adicionar Produto</button>
      <div class="alert success" id="alertBox">‚úÖ Produto salvo com sucesso no GitHub!</div>
    </form>
  </div>
  <div class="list-section">
    <h2>Itens Cadastrados</h2>
    <table>
      <thead>
        <tr>
          <th>T√≠tulo</th>
          <th>Valor (‚Ç¨)</th>
          <th>Departamento</th>
          <th>Estoque</th>
          <th>Data</th><th>WhatsApp</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="listaProdutos"></tbody>
    </table>
  </div>
</div>

<!-- GitHub Config Modal -->
<div class="modal" id="githubModal">
  <div class="modal-content">
    <button id="closeGithubModal" type="button" style="position:absolute; top:10px; right:10px; background:#ff3c00; border:none; color:#fff; padding:6px 12px; border-radius:6px; cursor:pointer;">X</button>
    <h2 style="margin-bottom:14px; color:var(--orange);">Configura√ß√£o GitHub</h2>
    <label>Repository (owner/repo)</label>
    <input id="ghRepo" placeholder="ex: usuario/repositorio" style="width:100%; margin-bottom:10px;" type="text" value=""/>
    <label>Branch</label>
    <input id="ghBranch" value="main"/>
    <label>File Path</label>
    <input id="ghPath" value="products.json"/>
    <label>Personal Access Token</label>
    <input id="ghToken" placeholder="ghp_xxx" style="width:100%; margin-bottom:16px;" type="password"/>
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button id="saveGithubConfig" type="button">Salvar</button>
      <button id="testGithubConfig" type="button">Testar conex√£o</button>
      <button id="downloadProductsJson" type="button">Baixar products.json</button>
    </div>
    <div id="ghAlert" style="margin-top:10px; display:none; padding:8px; border-radius:6px; text-align:center;"></div>
  </div>
</div>

<script>
  let produtos = [];

  // ===== Helpers UTF-8/Base64 seguros =====
  function decodeBase64Utf8(b64){
    try{
      b64 = (b64 || '').replace(/\n/g,'');
      if('TextDecoder' in window){
        const bin = atob(b64);
        const bytes = new Uint8Array(bin.length);
        for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
        return new TextDecoder().decode(bytes);
      }
      return decodeURIComponent(escape(atob(b64)));
    }catch(e){ console.error('decodeBase64Utf8 error', e); return atob(b64 || ''); }
  }
  function encodeBase64Utf8(str){
    try{
      if('TextEncoder' in window){
        const bytes = new TextEncoder().encode(str);
        let bin = '';
        bytes.forEach(b => bin += String.fromCharCode(b));
        return btoa(bin);
      }
      return btoa(unescape(encodeURIComponent(str)));
    }catch(e){ console.error('encodeBase64Utf8 error', e); return btoa(str || ''); }
  }

  // Upload imagens para GitHub e retorna URLs raw
  async function uploadImagens(produtoId, files){
    const cfg = JSON.parse(localStorage.getItem('ghConfig')||'{}');
    const uploadedLinks = [];
    for(let i=0; i<files.length; i++){
      const file = files[i];
      const reader = new FileReader();
      const base64 = await new Promise(res=>{
        reader.onload = () => res(reader.result.split(",")[1]);
        reader.readAsDataURL(file);
      });
      const imgPath = `products/${produtoId}/${file.name}`;
      const url = `https://api.github.com/repos/${cfg.repo}/contents/${imgPath}`;
      await fetch(url, {
        method: "PUT",
        headers: { "Authorization": `token ${cfg.token}`, "Content-Type": "application/json" },
        body: JSON.stringify({ message: \`Add image \${file.name} (\${produtoId})\`, branch: cfg.branch, content: base64 })
      });
      uploadedLinks.push(\`https://raw.githubusercontent.com/\${cfg.repo}/\${cfg.branch}/\${imgPath}\`);
    }
    return uploadedLinks;
  }

  function renderProdutos(){
    const lista = document.getElementById('listaProdutos');
    lista.innerHTML = '';
    produtos.forEach((p, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = \`
        <td>\${p.title}</td>
        <td>‚Ç¨ \${Number(p.price || 0).toFixed(2)}</td>
        <td>\${p.department || ''}</td>
        <td>\${p.stock ?? 0}</td>
        <td>\${new Date(p.createdAt).toLocaleDateString()}</td>
        <td>
          <div class='action-buttons'>
            <button onclick="editarProduto(\${i})">Editar</button>
            <button onclick="excluirProduto(\${i})">Excluir</button>
          </div>
        </td>\`;
      tr.innerHTML = tr.innerHTML.replace('</tr>', `<td>${(p.whatsapp||'')}</td></tr>`); lista.appendChild(tr);
    });
  }

  async function salvarNoGitHub(list){
    const cfg = JSON.parse(localStorage.getItem('ghConfig')||'{}');
    if(!cfg.repo || !cfg.branch || !cfg.path || !cfg.token){
      alert("Configura√ß√£o GitHub incompleta!");
      return;
    }
    const url = \`https://api.github.com/repos/\${cfg.repo}/contents/\${cfg.path}\`;
    let sha = null;
    try {
      const res = await fetch(url+\`?ref=\${cfg.branch}\`, { headers: { "Authorization": \`token \${cfg.token}\`, "Accept": "application/vnd.github+json" } });
      if(res.ok){ const data = await res.json(); sha = data.sha; }
    } catch(e) {}

    const sanitized = (list||[]).map(p => ({
      id: p.id || String(Date.now()),
      title: p.title ?? 'Sem t√≠tulo',
      description: p.description ?? '',
      department: p.department || 'marketplace',
      category: p.category || '',
      price: Number(p.price || 0),
      stock: Number.isFinite(p.stock) ? p.stock : parseInt(p.stock || '0', 10),
      image: p.image || '',
      gallery: Array.isArray(p.gallery) ? p.gallery.filter(Boolean) : [],
      createdAt: p.createdAt || Date.now(),
      status: p.status || 'publicado',
      whatsapp: p.whatsapp || ''
    }));

    const body = {
      message: "Atualizando products.json via Painel Brazucas",
      branch: cfg.branch,
      content: encodeBase64Utf8(JSON.stringify(sanitized, null, 2))
    };
    if(sha) body.sha = sha;

    const putRes = await fetch(url, {
      method: "PUT",
      headers: { "Authorization": \`token \${cfg.token}\`, "Accept": "application/vnd.github+json", "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    if(putRes.ok){
      const box = document.getElementById("alertBox");
      box.innerHTML = "‚úÖ Produto salvo no GitHub!";
      box.classList.add("success");
      box.style.display = "block";
      setTimeout(()=> box.style.display="none", 3000);
      await carregarProdutosGitHub();

  // === Robust open/close for GitHub modal ===
  function openGh(){
    try{ loadGithubConfig(); }catch(e){}
    var ghModal = document.getElementById('githubModal');
    if(ghModal){ ghModal.classList.add('show'); }
  }
  function closeGh(){
    var ghModal = document.getElementById('githubModal');
    if(ghModal){ ghModal.classList.remove('show'); }
  }
  document.addEventListener('DOMContentLoaded', function(){
    var openBtn = document.getElementById('openGithubModal');
    var closeBtn = document.getElementById('closeGithubModal');
    var ghModal = document.getElementById('githubModal');
    if(openBtn){ openBtn.addEventListener('click', openGh); }
    if(closeBtn){ closeBtn.addEventListener('click', closeGh); }
    if(ghModal){
      ghModal.addEventListener('click', function(e){
        if(e.target === ghModal){ closeGh(); }
      });
    }
  });


  // ===== Modal: open/close robust =====
  function ghModalOpen(){
    loadGithubConfig();
    const el = document.getElementById('githubModal');
    el.classList.add('show');
    el.style.display='flex';
  }
  function ghModalClose(){
    const el = document.getElementById('githubModal');
    el.classList.remove('show');
    el.style.display='none';
  }

  // Bindings (retry-safe)
  (function bindGhUI(){
    const openBtn = document.getElementById('openGithubModal');
    const closeBtn = document.getElementById('closeGithubModal');
    const saveBtn = document.getElementById('saveGithubConfig');
    const testBtn = document.getElementById('testGithubConfig');
    const dlBtn = document.getElementById('downloadProductsJson');
    if(openBtn) openBtn.onclick = ghModalOpen;
    if(closeBtn) closeBtn.onclick = ghModalClose;
    if(saveBtn) saveBtn.onclick = saveGithubConfig;
    if(testBtn) testBtn.onclick = testGithubConfig;
    if(dlBtn) dlBtn.onclick = downloadProducts;
  })();


  // (inline GitHub config removido ‚Äî usar modal)
  function ghGet(){ return JSON.parse(localStorage.getItem('ghConfig')||'{}'); }
  function ghSet(cfg){ localStorage.setItem('ghConfig', JSON.stringify(cfg)); }
  function ghLoadIntoInputs(){
    const cfg = ghGet();
    document.getElementById('ghRepoInline').value = cfg.repo || '';
    document.getElementById('ghBranchInline').value = cfg.branch || 'main';
    document.getElementById('ghPathInline').value = cfg.path || 'products.json';
    document.getElementById('ghTokenInline').value = cfg.token || '';
  }
  function ghSaveFromInputs(){
    const cfg = {
      repo: document.getElementById('ghRepoInline').value,
      branch: document.getElementById('ghBranchInline').value || 'main',
      path: document.getElementById('ghPathInline').value || 'products.json',
      token: document.getElementById('ghTokenInline').value
    };
    ghSet(cfg);
    showGhAlert('Configura√ß√£o salva!', true);
    loadGithubConfig(); // update modal too
  }
  async function ghTestFromInputs(){ testGithubConfig(); }
  async function ghDownloadFromInputs(){ downloadProducts(); }

  
  
  
  

    } else {
      alert("Erro ao salvar no GitHub.");
    }
  }

  // CRUD b√°sico
  document.getElementById('fotos').addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    const preview = document.getElementById('preview');
    preview.innerHTML = '';
    files.forEach((f, i) => {
      const url = URL.createObjectURL(f);
      const div = document.createElement('div');
      div.className = 'preview';
      div.innerHTML = \`<input type="radio" name="capa" \${i===0? 'checked' : ''} value="\${i}"><img src="\${url}">\`
      preview.appendChild(div);
    });
  });

  document.getElementById('formProduto').addEventListener('submit', async (e) => {
    e.preventDefault();
    const titulo = document.getElementById('titulo').value;
    const valor = Number(document.getElementById('valor').value || 0);
    const descricao = document.getElementById('descricao').value;
    const departamento = document.getElementById('departamento').value;
    const estoque = parseInt(document.getElementById('estoque').value || '0', 10);
    const whatsapp = (document.getElementById('whatsapp').value || '').replace(/\D+/g,'');

    const fotosInput = document.getElementById('fotos');
    const produtoId = Date.now().toString();
    const uploaded = await uploadImagens(produtoId, fotosInput.files || []);
    const capaIndex = parseInt(document.querySelector('input[name="capa"]:checked')?.value || 0);
    const image = uploaded[capaIndex] || '';
    const gallery = uploaded.filter((u,i)=> i!==capaIndex);

    const produto = { id: produtoId, title: titulo, price: valor, description: descricao, department: departamento, stock: estoque, whatsapp, image, gallery, createdAt: Date.now(), status: "publicado" };
    produtos.push(produto);
    await salvarNoGitHub(produtos);
    document.getElementById('formProduto').reset();
    document.getElementById('preview').innerHTML = '';
    renderProdutos();
  });

  async function excluirProduto(index){
    produtos.splice(index,1);
    await salvarNoGitHub(produtos);
    renderProdutos();
  }
  function editarProduto(index){
    const novo = prompt('Novo t√≠tulo para: ' + (produtos[index]?.title || ''));
    if(novo){ produtos[index].title = novo; salvarNoGitHub(produtos).then(renderProdutos); }
  }

  // ===== GitHub Modal (config/localStorage) =====
  const ghModal = document.getElementById('githubModal');
  const openBtn = document.getElementById('openGithubModal');
  const closeBtn = document.getElementById('closeGithubModal');
  const saveBtn = document.getElementById('saveGithubConfig');
  const testBtn = document.getElementById('testGithubConfig');
  const dlBtn = document.getElementById('downloadProductsJson');

  function showGhAlert(msg, success){
    const el = document.getElementById('ghAlert');
    el.textContent = msg;
    el.style.display = 'block';
    el.style.background = success ? '#28a745' : '#c0392b';
  }
  function loadGithubConfig(){
    const cfg = JSON.parse(localStorage.getItem('ghConfig')||'{}');
    if(cfg.repo) document.getElementById('ghRepo').value = cfg.repo;
    if(cfg.branch) document.getElementById('ghBranch').value = cfg.branch;
    if(cfg.path) document.getElementById('ghPath').value = cfg.path;
    if(cfg.token) document.getElementById('ghToken').value = cfg.token;
  }
  
  // Prefer values from the modal inputs if present
  function ghFromModalInputs(){
    const repo = document.getElementById('ghRepo')?.value?.trim() || '';
    const branch = document.getElementById('ghBranch')?.value?.trim() || '';
    const path = document.getElementById('ghPath')?.value?.trim() || '';
    const token = document.getElementById('ghToken')?.value || '';
    return { repo, branch, path, token };
  }

  function saveGithubConfig(){
    const cfgModal = ghFromModalInputs();
    const cfg = {
      repo: cfgModal.repo,
      branch: cfgModal.branch || 'main',
      path: cfgModal.path || 'products.json',
      token: cfgModal.token
    };
    localStorage.setItem('ghConfig', JSON.stringify(cfg));
    showGhAlert('Configura√ß√£o salva!', true);
    loadGithubConfig(); // keep modal in sync
  };
    localStorage.setItem('ghConfig', JSON.stringify(cfg));
    showGhAlert('Configura√ß√£o salva!', true);
  }
  async function testGithubConfig(){
    const cfgLS = JSON.parse(localStorage.getItem('ghConfig')||'{}');
    const modal = ghFromModalInputs();
    const cfg = {
      repo: modal.repo || cfgLS.repo,
      branch: modal.branch || cfgLS.branch || 'main',
      path: modal.path || cfgLS.path || 'products.json',
      token: modal.token || cfgLS.token
    };
    if(!cfg.repo || !cfg.branch || !cfg.path || !cfg.token){ showGhAlert('Preencha todos os campos antes de testar.', false); return; }
    try{
      const res = await fetch(`https://api.github.com/repos/${cfg.repo}/contents/${cfg.path}?ref=${cfg.branch}`, { headers: { Authorization: `token ${cfg.token}` } });
      if(res.ok){ showGhAlert('‚úÖ Conex√£o bem-sucedida!', true); } else { showGhAlert('‚ùå Erro: ' + res.status, false); }
    }catch(e){ showGhAlert('‚ùå Falha: ' + e.message, false); }
  }');
    if(!cfg.repo || !cfg.branch || !cfg.path || !cfg.token){ showGhAlert('Preencha todos os campos antes de testar.', false); return; }
    try{
      const res = await fetch(\`https://api.github.com/repos/\${cfg.repo}/contents/\${cfg.path}?ref=\${cfg.branch}\`, { headers: { Authorization: \`token \${cfg.token}\` } });
      if(res.ok){ showGhAlert('‚úÖ Conex√£o bem-sucedida!', true); } else { showGhAlert('‚ùå Erro: ' + res.status, false); }
    }catch(e){ showGhAlert('‚ùå Falha: ' + e.message, false); }
  }
  async function downloadProducts(){
    const cfgLS = JSON.parse(localStorage.getItem('ghConfig')||'{}');
    const modal = ghFromModalInputs();
    const cfg = {
      repo: modal.repo || cfgLS.repo,
      branch: modal.branch || cfgLS.branch || 'main',
      path: modal.path || cfgLS.path || 'products.json',
      token: modal.token || cfgLS.token
    };
    if(!cfg.repo || !cfg.branch || !cfg.path || !cfg.token){ showGhAlert('Preencha todos os campos antes de baixar.', false); return; }
    try{
      const res = await fetch(`https://api.github.com/repos/${cfg.repo}/contents/${cfg.path}?ref=${cfg.branch}`, { headers: { Authorization: `token ${cfg.token}` } });
      if(!res.ok){ showGhAlert('‚ùå Erro ao baixar: ' + res.status, false); return; }
      const data = await res.json();
      if(data && data.content){
        const b64 = (data.content || '').replace(/
/g,'');
        const bin = atob(b64);
        const bytes = new Uint8Array(bin.length);
        for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
        const blob = new Blob([bytes], {type: 'application/json;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const fname = (cfg.path.split('/').pop() || 'products.json');
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
        showGhAlert('üì• Download iniciado.', true);
      } else { showGhAlert('N√£o foi poss√≠vel obter o arquivo.', false); }
    }catch(e){ showGhAlert('‚ùå Falha: ' + (e.message || e), false); }
  }');
    if(!cfg.repo || !cfg.branch || !cfg.path || !cfg.token){ showGhAlert('Preencha todos os campos antes de baixar.', false); return; }
    try{
      const res = await fetch(\`https://api.github.com/repos/\${cfg.repo}/contents/\${cfg.path}?ref=\${cfg.branch}\`, { headers: { Authorization: \`token \${cfg.token}\` } });
      if(!res.ok){ showGhAlert('‚ùå Erro ao baixar: ' + res.status, false); return; }
      const data = await res.json();
      if(data && data.content){
        const b64 = (data.content || '').replace(/\n/g,'');
        const bin = atob(b64);
        const bytes = new Uint8Array(bin.length);
        for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
        const blob = new Blob([bytes], {type: 'application/json;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const fname = (cfg.path.split('/').pop() || 'products.json');
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
        showGhAlert('üì• Download iniciado.', true);
      } else { showGhAlert('N√£o foi poss√≠vel obter o arquivo.', false); }
    }catch(e){ showGhAlert('‚ùå Falha: ' + (e.message || e), false); }
  }

  if(openBtn){ openBtn.onclick = ()=>{ loadGithubConfig(); ghModal.classList.add('show'); }; }
  if(closeBtn){ closeBtn.onclick = ()=>{ ghModal.classList.remove('show'); }; }
  if(saveBtn){ saveBtn.onclick = saveGithubConfig; }
  if(testBtn){ testBtn.onclick = testGithubConfig; }
  if(dlBtn){ dlBtn.onclick = downloadProducts; }

  // Carregar lista inicial do GitHub
  async function carregarProdutosGitHub(){
    const cfg = JSON.parse(localStorage.getItem('ghConfig')||'{}');
    if(!cfg.repo || !cfg.branch || !cfg.path || !cfg.token) return;
    try {
      const res = await fetch(\`https://api.github.com/repos/\${cfg.repo}/contents/\${cfg.path}?ref=\${cfg.branch}\`, { headers: { Authorization: \`token \${cfg.token}\` } });
      if(res.ok){
        const data = await res.json();
        const raw = decodeBase64Utf8(data.content || '');
        produtos = JSON.parse(raw || '[]');
        renderProdutos();
      }
    } catch(e){ console.error("Erro ao carregar produtos:", e); }
  }
  carregarProdutosGitHub();

  // === Robust open/close for GitHub modal ===
  function openGh(){
    try{ loadGithubConfig(); }catch(e){}
    var ghModal = document.getElementById('githubModal');
    if(ghModal){ ghModal.classList.add('show'); }
  }
  function closeGh(){
    var ghModal = document.getElementById('githubModal');
    if(ghModal){ ghModal.classList.remove('show'); }
  }
  document.addEventListener('DOMContentLoaded', function(){
    var openBtn = document.getElementById('openGithubModal');
    var closeBtn = document.getElementById('closeGithubModal');
    var ghModal = document.getElementById('githubModal');
    if(openBtn){ openBtn.addEventListener('click', openGh); }
    if(closeBtn){ closeBtn.addEventListener('click', closeGh); }
    if(ghModal){
      ghModal.addEventListener('click', function(e){
        if(e.target === ghModal){ closeGh(); }
      });
    }
  });


  // ===== Modal: open/close robust =====
  function ghModalOpen(){
    loadGithubConfig();
    const el = document.getElementById('githubModal');
    el.classList.add('show');
    el.style.display='flex';
  }
  function ghModalClose(){
    const el = document.getElementById('githubModal');
    el.classList.remove('show');
    el.style.display='none';
  }

  // Bindings (retry-safe)
  (function bindGhUI(){
    const openBtn = document.getElementById('openGithubModal');
    const closeBtn = document.getElementById('closeGithubModal');
    const saveBtn = document.getElementById('saveGithubConfig');
    const testBtn = document.getElementById('testGithubConfig');
    const dlBtn = document.getElementById('downloadProductsJson');
    if(openBtn) openBtn.onclick = ghModalOpen;
    if(closeBtn) closeBtn.onclick = ghModalClose;
    if(saveBtn) saveBtn.onclick = saveGithubConfig;
    if(testBtn) testBtn.onclick = testGithubConfig;
    if(dlBtn) dlBtn.onclick = downloadProducts;
  })();


  // (inline GitHub config removido ‚Äî usar modal)
  function ghGet(){ return JSON.parse(localStorage.getItem('ghConfig')||'{}'); }
  function ghSet(cfg){ localStorage.setItem('ghConfig', JSON.stringify(cfg)); }
  function ghLoadIntoInputs(){
    const cfg = ghGet();
    document.getElementById('ghRepoInline').value = cfg.repo || '';
    document.getElementById('ghBranchInline').value = cfg.branch || 'main';
    document.getElementById('ghPathInline').value = cfg.path || 'products.json';
    document.getElementById('ghTokenInline').value = cfg.token || '';
  }
  function ghSaveFromInputs(){
    const cfg = {
      repo: document.getElementById('ghRepoInline').value,
      branch: document.getElementById('ghBranchInline').value || 'main',
      path: document.getElementById('ghPathInline').value || 'products.json',
      token: document.getElementById('ghTokenInline').value
    };
    ghSet(cfg);
    showGhAlert('Configura√ß√£o salva!', true);
    loadGithubConfig(); // update modal too
  }
  async function ghTestFromInputs(){ testGithubConfig(); }
  async function ghDownloadFromInputs(){ downloadProducts(); }

  
  
  
  


  // fechar ao clicar fora
  (function(){
    const modal = document.getElementById('githubModal');
    if(modal){
      modal.addEventListener('click', (e)=>{ if(e.target === modal){ ghModalClose(); } });
    }
  })();
</script>
</body>
</html>
