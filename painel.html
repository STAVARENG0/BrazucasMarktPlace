<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Painel ‚Äî Brazucas</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;800;900&display=swap" rel="stylesheet"/>
<style>
  :root{
    --cream:#ffffff;
    --pill-1:#1877F2;
    --pill-2:#1877F2;
    --shadow: rgba(0,0,0,.14);
    --white:#ffffff;
    --ink:#2b2b2b;
    --muted:#6b635a;
    --card:#ffffff;
    --border:#e5dfd7;
    --danger:#ff3c00;
    --success:#28a745;
    --fbblue:#1877F2;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--cream);
    color:var(--ink);
    font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    padding:20px;
  }
  .logo-small{width:56px;height:auto;display:block;margin:0 auto 18px;border-radius:8px}
  h1{line-height:0; text-align:center; margin:0 0 10px}

  .config-btn{
    display:block;
    margin:0 auto 18px;
    background:var(--fbblue);
    border:none;
    color:#fff;
    padding:10px 16px;
    border-radius:9999px;
    font-size:14px;
    font-weight:900;
    cursor:pointer;
    box-shadow:0 6px 14px var(--shadow)
  }
  .config-btn:hover{
    filter:brightness(1.05);
  }

  .container{display:flex; flex-wrap:wrap; gap:20px; max-width:1200px; margin:0 auto;}
  .card{
    flex:1 1 360px;
    background:var(--card);
    padding:20px;
    border-radius:12px;
    border:1px solid var(--border);
    box-shadow:0 10px 20px var(--shadow);
  }
  .form{display:flex; flex-direction:column; gap:12px}
  input, textarea, select{
    padding:12px;
    border-radius:10px;
    border:1px solid var(--border);
    font-size:14px;
    background:#fff
  }
  textarea{min-height:80px; resize:vertical}
  label{font-size:12px; color:var(--muted)}

  .upload-btn{
    display:inline-block;
    padding:12px 16px;
    border-radius:9999px;
    background:var(--fbblue);
    color:#fff;
    text-align:center;
    font-weight:800;
    cursor:pointer;
    transition:.2s;
    box-shadow:0 6px 14px var(--shadow), inset 0 -2px 0 rgba(0,0,0,.12)
  }
  .upload-btn:hover{ filter:brightness(1.05) }
  #fotos{ display:none }

  button.action{
    background:var(--fbblue);
    border:none;
    padding:12px 16px;
    border-radius:9999px;
    cursor:pointer;
    color:#fff;
    font-weight:800;
    font-size:15px;
    box-shadow:0 6px 14px var(--shadow), inset 0 -2px 0 rgba(0,0,0,.15)
  }
  button.action:hover{
    filter:brightness(1.05);
  }

  table{width:100%; border-collapse:collapse; margin-top:14px; min-width:600px;}
  th, td{border:1px solid var(--border); padding:10px; text-align:left; font-size:14px}
  th{background:#f9f4ed}
  .preview-container{display:flex; flex-wrap:wrap; gap:10px; margin-top:6px}
  .preview{position:relative}
  .preview img{width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border)}
  .preview input[type="radio"]{position:absolute;top:4px;left:4px;transform:scale(1.2)}
  .alert{margin-top:10px;padding:10px;border-radius:6px;text-align:center;display:none}
  .alert.success{background:var(--success);color:#fff}

  /* Generic Modal layout */
  .modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.85);
    justify-content:center;
    align-items:center;
    z-index:9999
  }
  .modal.show{display:flex !important}
  .modal-content{
    background:#fff;
    color:var(--ink);
    padding:20px;
    border-radius:12px;
    width:min(92vw,480px);
    border:1px solid var(--border);
    position:relative;
    box-shadow:0 14px 30px var(--shadow);
  }
  .modal-close{
    position:absolute;
    top:10px;
    right:10px;
    background:#ff3c00;
    border:none;
    color:#fff;
    padding:6px 12px;
    border-radius:6px;
    cursor:pointer;
    font-weight:800
  }

  /* GitHub modal grid */
  .gh-grid{display:grid; grid-template-columns:1fr; gap:8px}
  .gh-actions{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    justify-content:flex-end;
    margin-top:6px
  }
  .modal-content h2{
    color:#2b2b2b;
    font-weight:900;
    margin:0 0 12px
  }
  .gh-row{display:flex; flex-direction:column; gap:6px}
  .modal-content label{color:#6b635a; font-size:13px}
  .modal-content input,
  .modal-content select,
  .modal-content textarea{
    background:#fff;
    color:#222;
    border:1px solid var(--border);
    border-radius:10px;
    padding:12px;
    width:100%;
    font-size:14px;
    font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .gh-actions .action{
    background:var(--fbblue) !important;
    color:#fff !important;
    border-radius:9999px !important;
    box-shadow:0 6px 14px var(--shadow), inset 0 -2px 0 rgba(0,0,0,.12);
    padding:10px 14px
  }
  .modal-close{
    background:#ff3c00 !important;
    color:#fff !important
  }

  /* Edit modal extra layout */
  #editModal .modal-content{
    width:min(92vw,520px);
    max-height:90vh;
    overflow-y:auto;

    /* esconder scroll mas manter scroll√°vel */
    scrollbar-width:none;
  }
  #editModal .modal-content::-webkit-scrollbar{
    display:none;
  }

  #editModal h2{
    margin-top:0;
    font-weight:900;
    font-size:18px;
    color:var(--ink);
  }
  #editForm{
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  /* galeria no editar */
  #editGalleryPreview{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .edit-thumb{
    position:relative;
    width:60px;
    height:60px;
    flex:0 0 auto;
  }
  .edit-thumb img{
    width:60px;
    height:60px;
    object-fit:cover;
    border-radius:8px;
    border:1px solid var(--border);
    display:block;
  }
  .edit-thumb .edit-cover-radio{
    position:absolute;
    top:4px;
    left:4px;
    transform:scale(1.2);
    background:#fff;
    border-radius:4px;
  }
  .edit-thumb .remove-img-btn{
    position:absolute;
    top:4px;
    right:4px;
    background:var(--danger);
    border:none;
    color:#fff;
    font-size:11px;
    line-height:1;
    padding:4px 6px;
    border-radius:6px;
    cursor:pointer;
    font-weight:800;
  }

  @media(max-width:768px){
    table{font-size:12px}
    th,td{padding:8px}
  }
</style>
</head>
<body>
  <h1><img src="logo.png" alt="Brazucas" class="logo-small"></h1>
  <button class="config-btn" id="openGithubModal" onclick="openGh()">Configura√ß√µes</button>

  <div class="container">
    <div class="card">
      <form class="form" id="formProduto" novalidate>
        <input id="titulo" placeholder="T√≠tulo do produto" required type="text"/>
        <input id="valor" placeholder="Valor (‚Ç¨)" required step="0.01" type="number"/>
        <textarea id="descricao" placeholder="Descri√ß√£o do produto"></textarea>
        <label>Departamento</label>
        <select id="departamento" required>
          <option value="">Selecione...</option>
          <option value="marketplace">Marketplace</option>
          <option value="servicos">Servi√ßos e Com√©rcios</option>
          <option value="eventos">Eventos</option>
        </select>
        <label>Estoque</label>
        <input id="estoque" min="0" placeholder="Quantidade em estoque" type="number" value="0"/>
        <label>WhatsApp do dono (somente n√∫meros, com DDI)</label>
        <input id="whatsapp" placeholder="Digite o WhatsApp em qualquer formato" type="text" />
        <small style="color:var(--muted);margin-top:-6px;">Usado para abrir conversa no WhatsApp a partir do modal do produto.</small>
        <div class="region-row" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <div class="gh-row">
            <label>Condado (County)</label>
            <select id="county" required>
              <option value="">Selecione o condado‚Ä¶</option>
            </select>
          </div>
          <div class="gh-row">
            <label>Cidade / √Årea</label>
            <select id="city" required disabled>
              <option value="">Selecione uma cidade‚Ä¶</option>
              <option value="__custom__">Outra (digitar)</option>
            </select>
            <input id="cityCustom" type="text" placeholder="Digite a cidade" style="display:none; padding:12px; border:1px solid var(--border); border-radius:10px;" />
          </div>
        </div>

        <label class="upload-btn" for="fotos">üì∑ Adicionar Imagens</label>
        <input accept="image/*" id="fotos" multiple type="file"/>
        <div class="preview-container" id="preview"></div>

        <button type="submit" class="action" id="btnPublicar">Publicar Produto</button>
        <div class="alert success" id="alertBox">‚úÖ Produto salvo com sucesso no GitHub!</div>
      </form>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px">Itens Cadastrados</h2>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>T√≠tulo</th>
              <th>Valor (‚Ç¨)</th>
              <th>Departamento</th>
              <th>Estoque</th>
              <th>Data</th>
              <th>Condado</th>
              <th>Cidade</th>
              <th>WhatsApp</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="listaProdutos"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal GitHub -->
  <div class="modal" id="githubModal" aria-hidden="true">
    <div class="modal-content">
      <button class="modal-close" id="closeGithubModal" onclick="closeGh()" style="background:#ff3c00;color:#fff">X</button>
      <h2 style="margin:0 0 10px;">Configura√ß√£o GitHub</h2>
      <div class="gh-grid">
        <div class="gh-row">
          <label>Repository (owner/repo)</label>
          <input id="ghRepo" placeholder="ex: usuario/repositorio" type="text" style="background:#fff;color:#000;border:1px solid #333;border-radius:10px;padding:12px;width:100%"/>
        </div>
        <div class="gh-row">
          <label>Branch</label>
          <input id="ghBranch" placeholder="main" type="text" value="main" style="background:#fff;color:#000;border:1px solid #333;border-radius:10px;padding:12px;width:100%"/>
        </div>
        <div class="gh-row">
          <label>File Path</label>
          <input id="ghPath" placeholder="products.json" type="text" value="products.json" style="background:#fff;color:#000;border:1px solid #333;border-radius:10px;padding:12px;width:100%"/>
        </div>
        <div class="gh-row">
          <label>Personal Access Token</label>
          <input id="ghToken" placeholder="ghp_xxx" type="password" style="background:#fff;color:#000;border:1px solid #333;border-radius:10px;padding:12px;width:100%"/>
        </div>
      </div>
      <div class="gh-actions">
        <button id="saveGithubConfig" class="action">Salvar</button>
        <button id="testGithubConfig" class="action">Testar conex√£o</button>
        <button id="downloadProductsJson" class="action">Baixar products.json</button>
      </div>
      <div id="ghAlert" class="alert" style="display:none"></div>
    </div>
  </div>

  <!-- Modal Editar Produto -->
  <div class="modal" id="editModal" aria-hidden="true">
    <div class="modal-content">
      <button class="modal-close" onclick="closeEditModal()">X</button>
      <h2>Editar Produto</h2>
      <form id="editForm">
        <input type="hidden" id="editIndex"/>
        <div class="gh-row">
          <label for="editTitulo">T√≠tulo</label>
          <input id="editTitulo" type="text" required />
        </div>

        <div class="gh-row">
          <label for="editValor">Valor (‚Ç¨)</label>
          <input id="editValor" type="number" step="0.01" required />
        </div>

        <div class="gh-row">
          <label for="editDescricao">Descri√ß√£o</label>
          <textarea id="editDescricao" rows="3"></textarea>
        </div>

        <div class="gh-row">
          <label for="editDepartamento">Departamento</label>
          <select id="editDepartamento" required>
            <option value="marketplace">Marketplace</option>
            <option value="servicos">Servi√ßos e Com√©rcios</option>
            <option value="eventos">Eventos</option>
          </select>
        </div>

        <div class="gh-row">
          <label for="editEstoque">Estoque</label>
          <input id="editEstoque" type="number" min="0"/>
        </div>

        <div class="gh-row">
          <label for="editWhatsapp">WhatsApp do dono (somente n√∫meros, com DDI)</label>
          <input id="editWhatsapp" type="text"/>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div class="gh-row">
            <label for="editCounty">Condado (County)</label>
            <select id="editCounty" required></select>
          </div>
          <div class="gh-row">
            <label for="editCity">Cidade / √Årea</label>
            <select id="editCity" required disabled>
              <option value="">Selecione uma cidade‚Ä¶</option>
              <option value="__custom__">Outra (digitar)</option>
            </select>
            <input id="editCityCustom" type="text" placeholder="Digite a cidade" style="display:none; padding:12px; border:1px solid var(--border); border-radius:10px;" />
          </div>
        </div>

        <div class="gh-row">
          <label>Galeria</label>
          <div id="editGalleryPreview"></div>

          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;align-items:center;">
            <label class="upload-btn" for="editNewFotos" style="margin:0;">üì∑ Adicionar Imagens</label>
            <input id="editNewFotos" type="file" multiple accept="image/*" style="display:none;">
            <small style="font-size:12px;color:var(--muted);line-height:1.4;">Selecione a capa (bolinha branca) e remova imagens indesejadas (X).</small>
          </div>
        </div>

        <div class="gh-actions" style="justify-content:space-between;">
          <button type="button" class="action" style="background:#6b6b6b" onclick="closeEditModal()">Cancelar</button>
          <button type="submit" class="action">Salvar altera√ß√µes</button>
        </div>
      </form>
    </div>
  </div>

<script>
(function(){
  // ===== Utils =====
  function showGhAlert(msg, success){
    const el = document.getElementById('ghAlert');
    el.textContent = msg;
    el.style.display = 'block';
    el.style.background = success ? '#28a745' : '#c0392b';
    el.style.color = '#fff';
  }
  function encodeBase64Utf8(str){
    try{
      if('TextEncoder' in window){
        const bytes = new TextEncoder().encode(str);
        let bin=''; bytes.forEach(b=>bin+=String.fromCharCode(b));
        return btoa(bin);
      }
      return btoa(unescape(encodeURIComponent(str)));
    }catch(e){ return btoa(str||''); }
  }
  function decodeBase64Utf8(b64){
    try{
      b64 = (b64||'').replace(/\n/g,'');
      if('TextDecoder' in window){
        const bin = atob(b64);
        const bytes = new Uint8Array(bin.length);
        for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
        return new TextDecoder().decode(bytes);
      }
      return decodeURIComponent(escape(atob(b64)));
    }catch(e){ return atob(b64||''); }
  }

  // ===== Modal Config GitHub open/close =====
  window.openGh = function(){
    try{ loadGithubConfig(); }catch(e){}
    const m = document.getElementById('githubModal');
    if(m){ m.classList.add('show'); m.setAttribute('aria-hidden','false'); }
  };
  window.closeGh = function(){
    const m = document.getElementById('githubModal');
    if(m){ m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }
  };
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') { closeGh(); closeEditModal(); } });
  const modalEl = document.getElementById('githubModal');
  modalEl.addEventListener('click', (e)=>{ if(e.target===modalEl) closeGh(); });

  // ===== GitHub Config =====
  function ghGet(){ try{ return JSON.parse(localStorage.getItem('ghConfig')||'{}'); }catch(e){ return {}; } }
  function ghSet(cfg){ localStorage.setItem('ghConfig', JSON.stringify(cfg)); }
  function readModalCfg(){
    return {
      repo: (document.getElementById('ghRepo')?.value||'').trim(),
      branch: (document.getElementById('ghBranch')?.value||'main').trim() || 'main',
      path: (document.getElementById('ghPath')?.value||'products.json').trim() || 'products.json',
      token: (document.getElementById('ghToken')?.value||'')
    };
  }
  function loadGithubConfig(){
    const cfg = ghGet();
    if(cfg.repo) document.getElementById('ghRepo').value = cfg.repo;
    if(cfg.branch) document.getElementById('ghBranch').value = cfg.branch;
    if(cfg.path) document.getElementById('ghPath').value = cfg.path;
    if(cfg.token) document.getElementById('ghToken').value = cfg.token;
  }
  async function testGithubConfig(){
    const cfgLS = ghGet();
    const m = readModalCfg();
    const cfg = { repo:m.repo||cfgLS.repo, branch:m.branch||cfgLS.branch||'main', path:m.path||cfgLS.path||'products.json', token:m.token||cfgLS.token };
    if(!cfg.repo || !cfg.branch || !cfg.path || !cfg.token){ showGhAlert('Preencha todos os campos antes de testar.', false); return; }
    try{
      const res = await fetch('https://api.github.com/repos/'+cfg.repo+'/contents/'+cfg.path+'?ref='+cfg.branch, { headers: { Authorization: 'token '+cfg.token } });
      if(res.ok){ showGhAlert('‚úÖ Conex√£o bem-sucedida!', true); } else { showGhAlert('‚ùå Erro: ' + res.status, false); }
    }catch(e){ showGhAlert('‚ùå Falha: ' + e.message, false); }
  }
  async function downloadProducts(){
    const cfgLS = ghGet();
    const m = readModalCfg();
    const cfg = { repo:m.repo||cfgLS.repo, branch:m.branch||cfgLS.branch||'main', path:m.path||cfgLS.path||'products.json', token:m.token||cfgLS.token };
    if(!cfg.repo || !cfg.branch || !cfg.path || !cfg.token){ showGhAlert('Preencha todos os campos antes de baixar.', false); return; }
    try{
      const res = await fetch('https://api.github.com/repos/'+cfg.repo+'/contents/'+cfg.path+'?ref='+cfg.branch, { headers: { Authorization: 'token '+cfg.token } });
      if(!res.ok){ showGhAlert('‚ùå Erro ao baixar: ' + res.status, false); return; }
      const data = await res.json();
      if(data && data.content){
        const blob = new Blob([decodeBase64Utf8(data.content)], {type:'application/json;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = (cfg.path.split('/').pop() || 'products.json');
        document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
        showGhAlert('üì• Download iniciado.', true);
      } else { showGhAlert('N√£o foi poss√≠vel obter o arquivo.', false); }
    }catch(e){ showGhAlert('‚ùå Falha: ' + (e.message||e), false); }
  }
  function saveGithubConfig(){
    const cfg = readModalCfg();
    ghSet(cfg);
    showGhAlert('Configura√ß√£o salva!', true);
  }

  // Wire buttons (GitHub modal)
  document.getElementById('saveGithubConfig').addEventListener('click', saveGithubConfig);
  document.getElementById('testGithubConfig').addEventListener('click', testGithubConfig);
  document.getElementById('downloadProductsJson').addEventListener('click', downloadProducts);

  // === Ireland phone normalization ===
  function normalizeIEPhone(v){
    let d = String(v||'').replace(/\D+/g,'');
    if(!d) return '';
    if(d.startsWith('00353')){ d = '353' + d.slice(5); }
    if(d.startsWith('0')){ d = '353' + d.slice(1); }
    if(d.startsWith('3530')){ d = '353' + d.slice(4); }
    if(d.length > 15) d = d.slice(0,15);
    return d;
  }

  // ===== Toast/notify =====
  function toast(msg, ok){
    var el = document.getElementById('toast');
    if(!el) return;
    el.textContent = msg;
    el.style.background = ok ? '#1e2f22' : '#1a1a1a';
    el.style.borderColor = ok ? 'rgba(70,255,120,.25)' : 'rgba(255,255,255,.15)';
    el.style.display = 'block';
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>{ el.style.display='none'; }, 3200);
  }

  // ===== GitHub Upload Helpers =====
  async function readFileAsBase64(file){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = () => {
        const res = String(reader.result||'');
        const base64 = res.split(',')[1] || '';
        resolve(base64);
      };
      reader.onerror = e => reject(e);
      reader.readAsDataURL(file);
    });
  }

  async function getFileShaIfExists(repo, branch, path, token){
    const res = await fetch('https://api.github.com/repos/'+repo+'/contents/'+path+'?ref='+branch, {
      headers: { Authorization: 'token '+token, Accept: 'application/vnd.github+json' }
    });
    if(res.ok){
      const data = await res.json();
      return data.sha || null;
    }
    return null;
  }

  async function uploadGitHubFile({repo, branch, path, token, base64, message}){
    const sha = await getFileShaIfExists(repo, branch, path, token);
    const body = { message: message || ('upload '+path), branch, content: base64 };
    if(sha) body.sha = sha;
    const put = await fetch('https://api.github.com/repos/'+repo+'/contents/'+path, {
      method: 'PUT',
      headers: {
        Authorization: 'token '+token,
        Accept: 'application/vnd.github+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    if(!put.ok){
      toast('Erro ao subir '+ path +' ('+ put.status +')', false);
      throw new Error('Falha ao subir arquivo ' + path + ' (' + put.status + ')');
    }
    const json = await put.json();
    return (json.content && json.content.download_url) ? json.content.download_url :
           (json.content && json.content.html_url) || '';
  }

  function slugifyName(name){
    return String(name||'arquivo').toLowerCase()
      .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
  }

  // ===== Produtos CRUD (com WhatsApp) =====
  let produtos = [];

  function renderProdutos(){
    const lista = document.getElementById('listaProdutos');
    lista.innerHTML = '';
    produtos.forEach((p,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.title||''}</td>
        <td>‚Ç¨ ${(Number(p.price||0)).toFixed(2)}</td>
        <td>${p.department||''}</td>
        <td>${p.stock??0}</td>
        <td>${new Date(p.createdAt||Date.now()).toLocaleDateString()}</td>
        <td>${p.county||''}</td>
        <td>${p.city||''}</td>
        <td>${p.whatsapp||''}</td>
        <td>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="action" data-edit="${i}">Editar</button>
            <button class="action" data-del="${i}">Excluir</button>
          </div>
        </td>`;
      lista.appendChild(tr);
    });
    // wire edit/delete
    lista.querySelectorAll('button[data-edit]').forEach(btn=>btn.onclick=()=>openEditModal(Number(btn.dataset.edit)));
    lista.querySelectorAll('button[data-del]').forEach(btn=>btn.onclick=()=>excluirProduto(Number(btn.dataset.del)));
  }

  async function salvarNoGitHub(list){
    const cfg = ghGet();
    if(!cfg.repo || !cfg.branch || !cfg.path || !cfg.token){
      alert('Configura√ß√£o GitHub incompleta!');
      return;
    }
    const url = 'https://api.github.com/repos/'+cfg.repo+'/contents/'+cfg.path;
    let sha = null;
    try{
      const res = await fetch(url+'?ref='+cfg.branch,{
        headers:{Authorization:'token '+cfg.token,Accept:'application/vnd.github+json'}
      });
      if(res.ok){
        const data = await res.json();
        sha = data.sha;
      }
    }catch(e){}

    const sanitized = (list||[]).map(p=>({
      id: p.id || String(Date.now()),
      title: p.title ?? 'Sem t√≠tulo',
      description: p.description ?? '',
      department: p.department || 'marketplace',
      category: p.category || '',
      price: Number(p.price || 0),
      stock: Number.isFinite(p.stock) ? p.stock : parseInt(p.stock || '0', 10),
      image: p.image || '',
      gallery: Array.isArray(p.gallery)? p.gallery.filter(Boolean) : [],
      whatsapp: p.whatsapp || '',
      createdAt: p.createdAt || Date.now(),
      status: p.status || 'publicado',
      county: p.county || '',
      city: p.city || ''
    }));

    const body = {
      message:"Atualizando products.json via Painel Brazucas",
      branch:cfg.branch,
      content: encodeBase64Utf8(JSON.stringify(sanitized,null,2))
    };
    if(sha) body.sha = sha;

    const putRes = await fetch(url, {
      method:'PUT',
      headers:{
        Authorization:'token '+cfg.token,
        Accept:'application/vnd.github+json',
        'Content-Type':'application/json'
      },
      body: JSON.stringify(body)
    });

    if(putRes.ok){
      toast('‚úÖ Produto enviado pela Products Johnson!', true);
      const box = document.getElementById('alertBox');
      box.style.display='block';
      box.classList.add('success');
      box.textContent='‚úÖ Produto enviado pela Products Johnson!';
      setTimeout(()=> box.style.display='none', 2800);

      await carregarProdutosGitHub();
    } else {
      alert('Erro ao salvar no GitHub.');
    }
  }

  document.getElementById('fotos').addEventListener('change', (e)=>{
    const files = Array.from(e.target.files);
    const preview = document.getElementById('preview');
    preview.innerHTML = '';
    files.forEach((f,i)=>{
      const url = URL.createObjectURL(f);
      const div = document.createElement('div');
      div.className='preview';
      div.innerHTML = '<input type="radio" name="capa" '+(i===0?'checked':'')+' value="'+i+'"><img src="'+url+'">';
      preview.appendChild(div);
    });
  });

  document.getElementById('formProduto').addEventListener('submit', async (e)=>{
    e.preventDefault();

    toast('Enviando produto...', false);

    const titulo = document.getElementById('titulo').value;
    const valor = Number(document.getElementById('valor').value || 0);
    const descricao = document.getElementById('descricao').value;
    const departamento = document.getElementById('departamento').value;
    const estoque = parseInt(document.getElementById('estoque').value || '0', 10);

    let whatsapp = normalizeIEPhone(document.getElementById('whatsapp').value || '');
    if(!whatsapp || whatsapp.length < 11){
      alert('N√∫mero inv√°lido. Use +353871234567 ou 0871234567');
      return;
    }

    const county = document.getElementById('county').value;
    let city = document.getElementById('city').value;
    if(city==='__custom__'){
      city = (document.getElementById('cityCustom').value||'').trim();
    }

    // Upload de imagens para GitHub (pasta por produto) e usar apenas URLs no JSON
    const cfg = ghGet();
    const productId = Date.now().toString();
    const files = Array.from(document.getElementById('fotos').files || []);
    let coverIndex = 0;
    const checked = document.querySelector('input[name="capa"]:checked');
    if(checked){
      coverIndex = parseInt(checked.value || '0', 10) || 0;
    }
    let galleryUrls = [];
    if(cfg.repo && cfg.branch && cfg.token && files.length){
      const imgBase = 'images/'+productId;
      toast('Enviando imagens...', false);
      for(let i=0;i<files.length;i++){
        const f = files[i];
        const ext = (f.name.split('.').pop()||'jpg').toLowerCase();
        const fname = slugifyName(f.name.replace(/\.[^.]+$/, '')) + '.' + ext;
        const destPath = imgBase + '/' + fname;
        const b64 = await readFileAsBase64(f);
        toast('Enviando imagem '+(i+1)+' de '+files.length+'...', false);
        const url = await uploadGitHubFile({
          repo: cfg.repo,
          branch: cfg.branch,
          path: destPath,
          token: cfg.token,
          base64: b64,
          message: 'Upload image for product '+productId
        });
        galleryUrls.push(url);
      }
    }
    toast('Imagens enviadas com sucesso ‚úÖ', true);

    const imageUrl = galleryUrls.length ? galleryUrls[Math.min(coverIndex, galleryUrls.length-1)] : '';
    const produto = {
      id: productId,
      title: titulo,
      price: valor,
      description: descricao,
      department: departamento,
      county,
      city,
      stock: estoque,
      whatsapp,
      image: imageUrl,
      gallery: galleryUrls,
      createdAt: Date.now(),
      status:'publicado'
    };

    produtos.push(produto);
    await salvarNoGitHub(produtos);

    e.target.reset();
    document.getElementById('preview').innerHTML='';
    renderProdutos();
  });

  function excluirProduto(i){
    produtos.splice(i,1);
    salvarNoGitHub(produtos).then(renderProdutos);
  }

  // ======== EDIT MODAL FUNCTIONS ========

  // dados tempor√°rios da galeria durante edi√ß√£o
  let editTempGallery = []; // [{url,isNew,file}]
  let editTempCoverIndex = 0;
  let editNewFiles = []; // arquivos novos ainda n√£o enviados

  // popular selects Condado/Cidade no modal de edi√ß√£o
  function populateEditCounties(selectedCounty){
    const sel = document.getElementById('editCounty');
    if(!sel) return;
    sel.innerHTML = '<option value="">Selecione o condado‚Ä¶</option>' +
      Object.keys(COUNTY_CITIES).sort().map(function(c){
        return '<option value="'+c+'">'+c+'</option>';
      }).join('') +
      '<option value="__custom__">Outro (digitar)</option>';
    if(selectedCounty){
      sel.value = selectedCounty;
      if(!sel.value){
        sel.value = '__custom__';
      }
    }
  }

  function populateEditCities(){
    const countyEl = document.getElementById('editCounty');
    const county = countyEl ? countyEl.value : '';
    const citySel = document.getElementById('editCity');
    if(!citySel) return;
    const list = COUNTY_CITIES[county] || [];
    citySel.disabled = !list.length;
    citySel.innerHTML =
      '<option value="">'+(list.length? 'Selecione uma cidade‚Ä¶' : 'Selecione o condado primeiro‚Ä¶')+'</option>' +
      list.map(function(n){
        return '<option value="'+n+'">'+n+'</option>';
      }).join('') +
      '<option value="__custom__">Outra (digitar)</option>';
  }

  function toggleEditCityCustom(){
    var sel = document.getElementById('editCity');
    var input = document.getElementById('editCityCustom');
    if(!sel || !input) return;
    if(sel.value === '__custom__'){
      input.style.display='block';
      input.focus();
    } else {
      input.style.display='none';
    }
  }

  function renderEditGallery(){
    const wrap = document.getElementById('editGalleryPreview');
    wrap.innerHTML = '';
    editTempGallery.forEach((item, idx)=>{
      const div = document.createElement('div');
      div.className = 'edit-thumb';
      div.setAttribute('data-idx', idx);

      const img = document.createElement('img');
      img.src = item.url;
      img.alt = 'Imagem do produto';

      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.className = 'edit-cover-radio';
      radio.name = 'editCapa';
      radio.setAttribute('data-idx', idx);
      if(idx === editTempCoverIndex){ radio.checked = true; }

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'remove-img-btn';
      btn.setAttribute('data-idx', idx);
      btn.textContent = '‚úï';

      div.appendChild(img);
      div.appendChild(radio);
      div.appendChild(btn);
      wrap.appendChild(div);
    });
  }

  // delega clique do preview para remover ou trocar capa
  document.addEventListener('click', function(e){
    if(e.target.classList.contains('remove-img-btn')){
      const idx = parseInt(e.target.getAttribute('data-idx'),10);
      if(!isNaN(idx)){
        editTempGallery.splice(idx,1);
        if(editTempCoverIndex === idx){
          editTempCoverIndex = 0;
        }else if(editTempCoverIndex > idx){
          editTempCoverIndex--;
        }
        renderEditGallery();
      }
    }
    if(e.target.classList.contains('edit-cover-radio')){
      const idx = parseInt(e.target.getAttribute('data-idx'),10);
      if(!isNaN(idx)){
        editTempCoverIndex = idx;
        renderEditGallery();
      }
    }
  });

  // adicionar novas imagens no modo edi√ß√£o (pr√©-visualiza√ß√£o local)
  document.getElementById('editNewFotos').addEventListener('change', (e)=>{
    const files = Array.from(e.target.files||[]);
    files.forEach(f=>{
      const objUrl = URL.createObjectURL(f);
      editTempGallery.push({url:objUrl,isNew:true,file:f});
      editNewFiles.push(f);
    });
    // se n√£o tem capa ainda define a primeira
    if(editTempGallery.length && (editTempCoverIndex<0 || editTempCoverIndex>=editTempGallery.length)){
      editTempCoverIndex = 0;
    }
    renderEditGallery();
    // limpa input pra poder adicionar o mesmo arquivo dnv se quiser
    e.target.value = '';
  });

  function openEditModal(i){
    const p = produtos[i];
    if(!p) return;

    document.getElementById('editIndex').value = i;
    document.getElementById('editTitulo').value = p.title || '';
    document.getElementById('editValor').value = Number(p.price||0);
    document.getElementById('editDescricao').value = p.description || '';
    document.getElementById('editDepartamento').value = p.department || 'marketplace';
    document.getElementById('editEstoque').value = p.stock ?? 0;
    document.getElementById('editWhatsapp').value = p.whatsapp || '';

    // condado / cidade
    populateEditCounties(p.county || '');
    populateEditCities();
    const editCitySel = document.getElementById('editCity');
    const editCityInput = document.getElementById('editCityCustom');

    if((COUNTY_CITIES[p.county||'']||[]).includes(p.city)){
      editCitySel.disabled = false;
      editCitySel.value = p.city;
      editCityInput.style.display='none';
      editCityInput.value = '';
    }else{
      editCitySel.disabled = false;
      editCitySel.value = '__custom__';
      editCityInput.style.display='block';
      editCityInput.value = p.city || '';
    }

    // galeria temp (existente)
    editTempGallery = [];
    const imgs = [];
    if(p.image) imgs.push(p.image);
    if(Array.isArray(p.gallery)) imgs.push(...p.gallery);
    const uniq = [];
    imgs.forEach(src=>{ if(src && !uniq.includes(src)) uniq.push(src); });
    uniq.forEach(u=>{
      editTempGallery.push({url:u,isNew:false});
    });

    // capa inicial
    let coverUrl = p.image || (uniq.length?uniq[0]:'');
    editTempCoverIndex = Math.max(0, editTempGallery.findIndex(g=>g.url===coverUrl));
    if(editTempCoverIndex === -1){ editTempCoverIndex = 0; }

    // limpa arquivos novos
    editNewFiles = [];

    renderEditGallery();

    // abrir modal
    const m = document.getElementById('editModal');
    if(m){
      m.classList.add('show');
      m.setAttribute('aria-hidden','false');
    }
  }
  window.openEditModal = openEditModal;

  function closeEditModal(){
    const m = document.getElementById('editModal');
    if(m){
      m.classList.remove('show');
      m.setAttribute('aria-hidden','true');
    }
  }
  window.closeEditModal = closeEditModal;

  // salva altera√ß√µes do modal de edi√ß√£o
  document.getElementById('editForm').addEventListener('submit', async function(ev){
    ev.preventDefault();
    const idx = parseInt(document.getElementById('editIndex').value,10);
    if(isNaN(idx) || !produtos[idx]){ closeEditModal(); return; }

    const editedCounty = document.getElementById('editCounty').value || '';
    let editedCitySel = document.getElementById('editCity').value || '';
    if(editedCitySel==='__custom__'){
      editedCitySel = (document.getElementById('editCityCustom').value||'').trim();
    }

    let editedWhatsapp = normalizeIEPhone(document.getElementById('editWhatsapp').value || '');
    if(!editedWhatsapp || editedWhatsapp.length < 11){
      alert('N√∫mero inv√°lido. Use +353871234567 ou 0871234567');
      return;
    }

    produtos[idx].title = document.getElementById('editTitulo').value || '';
    produtos[idx].price = Number(document.getElementById('editValor').value || 0);
    produtos[idx].description = document.getElementById('editDescricao').value || '';
    produtos[idx].department = document.getElementById('editDepartamento').value || 'marketplace';
    produtos[idx].stock = parseInt(document.getElementById('editEstoque').value || '0', 10);
    produtos[idx].whatsapp = editedWhatsapp;
    produtos[idx].county = editedCounty;
    produtos[idx].city = editedCitySel;

    // ====== Upload novos arquivos (se houver) ======
    const cfg = ghGet();
    const productId = produtos[idx].id || Date.now().toString();
    let uploadedUrls = [];
    if(cfg.repo && cfg.branch && cfg.token && editNewFiles.length){
      const imgBase = 'images/'+productId;
      toast('Enviando novas imagens...', false);
      for(let i=0;i<editNewFiles.length;i++){
        const f = editNewFiles[i];
        const ext = (f.name.split('.').pop()||'jpg').toLowerCase();
        const fname = slugifyName(f.name.replace(/\.[^.]+$/, '')) + '.' + ext;
        const destPath = imgBase + '/' + fname;
        const b64 = await readFileAsBase64(f);
        toast('Enviando imagem '+(i+1)+' de '+editNewFiles.length+'...', false);
        const url = await uploadGitHubFile({
          repo: cfg.repo,
          branch: cfg.branch,
          path: destPath,
          token: cfg.token,
          base64: b64,
          message: 'Upload image (edit) for product '+productId
        });
        uploadedUrls.push(url);
      }
      toast('Novas imagens enviadas ‚úÖ', true);
    }

    // Monta galeria final preservando ordem atual da edi√ß√£o
    const finalGallery = [];
    let uploadPtr = 0;
    editTempGallery.forEach(g=>{
      if(g.isNew){
        // pega URL real enviada
        const realUrl = uploadedUrls[uploadPtr] || '';
        uploadPtr++;
        if(realUrl) finalGallery.push(realUrl);
      } else {
        if(g.url) finalGallery.push(g.url);
      }
    });

    // capa final
    const finalCoverUrl = finalGallery[editTempCoverIndex] || finalGallery[0] || '';

    produtos[idx].image = finalCoverUrl;
    produtos[idx].gallery = finalGallery;

    await salvarNoGitHub(produtos);
    renderProdutos();
    closeEditModal();
  });

  // ===== Carregar produtos do GitHub (para persist√™ncia ap√≥s reload) =====
  async function carregarProdutosGitHub(){
    const cfg = ghGet();
    if(!cfg.repo || !cfg.branch || !cfg.path || !cfg.token){
      renderProdutos();
      return;
    }
    try{
      const res = await fetch('https://api.github.com/repos/'+cfg.repo+'/contents/'+cfg.path+'?ref='+cfg.branch, {
        headers:{ Authorization:'token '+cfg.token }
      });
      if(res.ok){
        const data = await res.json();
        const raw = decodeBase64Utf8(data.content || '');
        produtos = JSON.parse(raw || '[]');
      }else{
        produtos = [];
      }
    }catch(e){
      console.error('Erro ao carregar produtos:', e);
      produtos = [];
    }
    renderProdutos();
  }

  // ==== County & City selector (form de cria√ß√£o) ====
  const COUNTY_CITIES = {"Carlow": ["Carlow Town", "Tullow", "Bagenalstown", "Clonegal", "Rathvilly", "Borris", "Hacketstown", "Ballon", "Fenagh", "Nurney"], "Cavan": ["Cavan Town", "Bailieborough", "Virginia", "Kingscourt", "Cootehill", "Belturbet", "Ballyjamesduff", "Arvagh", "Killeshandra", "Mullagh"], "Clare": ["Ennis", "Shannon", "Kilrush", "Ennistymon", "Kilkee", "Lahinch", "Lisdoonvarna", "Miltown Malbay", "Sixmilebridge", "Tulla", "Newmarket-on-Fergus", "Scarriff", "Killaloe", "Bodyke", "Quin"], "Cork": ["Cork City", "Ballincollig", "Carrigaline", "Cobh", "Mallow", "Midleton", "Youghal", "Clonakilty", "Bandon", "Skibbereen", "Kinsale", "Macroom", "Bantry", "Fermoy", "Charleville", "Passage West", "Kanturk", "Mitchelstown", "Glanmire", "Douglas", "Carrigtwohill", "Coachford", "Buttevant", "Millstreet", "Drimoleague"], "Donegal": ["Letterkenny", "Buncrana", "Ballybofey", "Bundoran", "Donegal Town", "Killybegs", "Derrybeg", "Gweedore", "Glenties", "Carndonagh", "Moville", "Ramelton", "Rathmullan", "Milford", "Falcarragh", "Dungloe", "Ballyshannon", "Lifford"], "Dublin": ["Dublin 1", "Dublin 2", "Dublin 3", "Dublin 4", "Dublin 5", "Dublin 6", "Dublin 6W", "Dublin 7", "Dublin 8", "Dublin 9", "Dublin 10", "Dublin 11", "Dublin 12", "Dublin 13", "Dublin 14", "Dublin 15", "Dublin 16", "Dublin 17", "Dublin 18", "Dublin 20", "Dublin 22", "Dublin 24", "D√∫n Laoghaire", "Blackrock", "Stillorgan", "Dundrum", "Sandyford", "Ranelagh", "Rathmines", "Rathgar", "Terenure", "Templeogue", "Clonskeagh", "Donnybrook", "Ballsbridge", "Irishtown", "Sandycove", "Monkstown", "Dalkey", "Killiney", "Shankill", "Lucan", "Palmerstown", "Chapelizod", "Clondalkin", "Tallaght", "Rathfarnham", "Knocklyon", "Blanchardstown", "Castleknock", "Clonsilla", "Swords", "Malahide", "Portmarnock", "Howth", "Baldoyle", "Donabate", "Skerries", "Rush", "Lusk", "Balbriggan", "Raheny", "Artane", "Beaumont", "Santry", "Drumcondra", "Phibsborough", "Cabra", "Finglas", "Ballymun", "Coolock", "Clontarf"], "Galway": ["Galway City", "Athenry", "Tuam", "Ballinasloe", "Loughrea", "Oranmore", "Gort", "Portumna", "Moycullen", "Claregalway", "Kinvara", "Headford", "Oughterard", "Barna", "Spiddal", "Carraroe (An Cheathr√∫ Rua)", "Inverin", "Leenane", "Mountbellew", "Dunmore", "Glenamaddy", "Ballinderreen", "Craughwell", "Abbeyknockmoy", "Ahascragh", "Ardrahan", "Ballygar", "Peterswell", "Clifden", "Recess", "Roundstone"], "Kerry": ["Tralee", "Killarney", "Listowel", "Dingle", "Kenmare", "Cahersiveen", "Killorglin", "Castleisland", "Sneem", "Waterville", "Annascaul", "Ballybunion"], "Kildare": ["Naas", "Newbridge", "Maynooth", "Celbridge", "Leixlip", "Athy", "Kildare Town", "Kilcullen", "Monasterevin", "Clane", "Sallins", "Rathangan", "Prosperous"], "Kilkenny": ["Kilkenny City", "Callan", "Thomastown", "Graiguenamanagh", "Castlecomer", "Bennettsbridge", "Gowran", "Urlingford", "Mooncoin", "Piltown", "Freshford"], "Laois": ["Portlaoise", "Portarlington", "Mountmellick", "Abbeyleix", "Stradbally", "Durrow", "Mountrath", "Rathdowney", "Emo", "Ballylinan"], "Leitrim": ["Carrick-on-Shannon", "Manorhamilton", "Ballinamore", "Mohill", "Drumshanbo", "Dromahair"], "Limerick": ["Limerick City", "Newcastle West", "Abbeyfeale", "Kilmallock", "Rathkeale", "Askeaton", "Adare", "Croom", "Bruff"], "Longford": ["Longford Town", "Granard", "Lanesborough", "Edgeworthstown", "Ballymahon", "Newtownforbes"], "Louth": ["Dundalk", "Drogheda", "Ardee", "Blackrock", "Carlingford", "Castlebellingham", "Termonfeckin"], "Mayo": ["Castlebar", "Ballina", "Westport", "Claremorris", "Ballinrobe", "Swinford", "Belmullet", "Foxford", "Ballyhaunis", "Louisburgh", "Newport", "Charlestown"], "Meath": ["Navan", "Ashbourne", "Trim", "Kells", "Laytown‚ÄìBettystown", "Ratoath", "Dunboyne", "Duleek", "Kildalkey", "Athboy", "Enfield", "Oldcastle"], "Monaghan": ["Monaghan Town", "Carrickmacross", "Castleblayney", "Clones", "Ballybay", "Emyvale"], "Offaly": ["Tullamore", "Birr", "Edenderry", "Clara", "Banagher", "Ferbane", "Daingean", "Kilcormac", "Shannonbridge"], "Roscommon": ["Roscommon Town", "Boyle", "Castlerea", "Ballaghaderreen", "Strokestown", "Lanesborough", "Elphin"], "Sligo": ["Sligo Town", "Tubbercurry", "Enniscrone", "Collooney", "Ballymote", "Grange", "Strandhill"], "Tipperary": ["Clonmel", "Nenagh", "Thurles", "Tipperary Town", "Carrick-on-Suir", "Templemore", "Cashel", "Roscrea", "Cahir", "Borrisokane"], "Waterford": ["Waterford City", "Tramore", "Dungarvan", "Lismore", "Cappoquin", "Kilmacthomas"], "Westmeath": ["Athlone", "Mullingar", "Moate", "Kinnegad", "Castlepollard", "Kilbeggan", "Rochfortbridge"], "Wexford": ["Wexford Town", "Gorey", "Enniscorthy", "New Ross", "Rosslare", "Courtown", "Bunclody", "Taghmon"], "Wicklow": ["Bray", "Greystones", "Arklow", "Wicklow Town", "Blessington", "Baltinglass", "Newtownmountkennedy", "Rathnew", "Kilcoole", "Roundwood"]};

  function populateCounties(){
    const sel = document.getElementById('county');
    if(!sel) return;
    sel.innerHTML = '<option value="">Selecione o condado‚Ä¶</option>' +
      Object.keys(COUNTY_CITIES).sort().map(function(c){
        return '<option value="'+c+'">'+c+'</option>';
      }).join('') +
      '<option value="__custom__">Outro (digitar)</option>';
  }

  function populateCities(){
    const countyEl = document.getElementById('county');
    const county = countyEl ? countyEl.value : '';
    const citySel = document.getElementById('city');
    if(!citySel) return;
    const list = COUNTY_CITIES[county] || [];
    citySel.disabled = !list.length;
    citySel.innerHTML =
      '<option value="">'+(list.length? 'Selecione uma cidade‚Ä¶' : 'Selecione o condado primeiro‚Ä¶')+'</option>' +
      list.map(function(n){
        return '<option value="'+n+'">'+n+'</option>';
      }).join('') +
      '<option value="__custom__">Outra (digitar)</option>';
  }

  function toggleCityCustom(){
    var sel = document.getElementById('city');
    var input = document.getElementById('cityCustom');
    if(!sel || !input) return;
    if(sel.value === '__custom__'){
      input.style.display='block';
      input.focus();
    } else {
      input.style.display='none';
    }
  }

  // Eventos county/city do modal de edi√ß√£o
  document.getElementById('editCounty').addEventListener('change', function(){
    populateEditCities();
  });
  document.getElementById('editCity').addEventListener('change', function(){
    toggleEditCityCustom();
  });

  // ===== Init on DOMContentLoaded =====
  document.addEventListener('DOMContentLoaded', async function(){
    // preparar selects do formul√°rio de cria√ß√£o
    populateCounties();
    var countyEl = document.getElementById('county');
    if(countyEl){ countyEl.addEventListener('change', populateCities); }

    var citySel = document.getElementById('city');
    if(citySel){ citySel.addEventListener('change', toggleCityCustom); }

    // carregar lista inicial direto do GitHub
    await carregarProdutosGitHub();
  });

})();</script>

<div id="toast" style="position:fixed; right:16px; bottom:16px; z-index:10000; display:none; background:#1a1a1a; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.1)"></div>
</body>
</html>
